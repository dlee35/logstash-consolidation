filter {
    if [type] =~ "bro_" {
        # If message looks like json, try to parse it as such. Otherwise, fall back to csv or grok.
        if [message] =~ /^{.*}$/ {
            mutate {
                    rename => { "tags" => "tags-orig" }
            }

            json {
                    source => "message"
            }

            mutate {
                    rename => { "ts" => "timestamp" }
                    rename => { "id.orig_h" => "source_ip" }
                    rename => { "id.orig_p" => "source_port" }
                    rename => { "id.resp_h" => "destination_ip" }
                    rename => { "id.resp_p" => "destination_port" }
            }
            if [type] == "bro_conn" {
                mutate {
                    #ts
                    #uid
                    #id.orig_h
                    #id.orig_p
                    #id.resp_h
                    #id.resp_p
                    rename => { "proto" => "protocol" }
                    #service
                    #duration
                    rename => { "orig_bytes" => "original_bytes" }
                    rename => { "resp_bytes" => "respond_bytes" }
                    rename => { "conn_state" => "connection_state" }
                    #local_orig
                    rename => { "local_resp" => "local_respond" }
                    #missed_bytes
                    #history field
                    rename => { "orig_pkts" => "original_packets" }
                    rename => { "orig_ip_bytes" => "original_ip_bytes" }
                    rename => { "resp_pkts" => "respond_packets" }
                    rename => { "resp_ip_bytes" => "respond_ip_bytes" }
                    #tunnel_parents
                    rename => { "orig_cc" => "original_country_code" }
                    rename => { "resp_cc" => "respond_country_code" }
                    rename => { "sensorname" => "sensor_name" }
                  }
                translate {
                    field => "connection_state"

                    destination => "connection_state_description"

                    dictionary => [
                                  "S0", "Connection attempt seen, no reply",
                                  "S1", "Connection established, not terminated",
                                  "S2", "Connection established and close attempt by originator seen (but no reply from responder)",
                                  "S3", "Connection established and close attempt by responder seen (but no reply from originator)",
                                  "SF", "Normal SYN/FIN completion",
                                  "REJ", "Connection attempt rejected",
                                  "RSTO", "Connection established, originator aborted (sent a RST)",
                                  "RSTR", "Established, responder aborted",
                                  "RSTOS0", "Originator sent a SYN followed by a RST, we never saw a SYN-ACK from the responder",
                                  "RSTRH", "Responder sent a SYN ACK followed by a RST, we never saw a SYN from the (purported) originator",
                                  "SH", "Originator sent a SYN followed by a FIN, we never saw a SYN ACK from the responder (hence the connection was 'half' open)",
                                  "SHR", "Responder sent a SYN ACK followed by a FIN, we never saw a SYN from the originator",
                                  "OTH", "No SYN seen, just midstream traffic (a 'partial connection' that was not later closed)"
                                  ]
                }
            } else if [type] == "bro_dhcp" {
                mutate {
                    #ts
                    #uid
                    #id.orig_h
                    #id.orig_p
                    #id.resp_h
                    #id.resp_p
                    #mac
                    #assigned_ip
                    #lease_time
                    rename => { "trans_id" => "transaction_id" }
                    # new dhcp log format
                    rename => { "assigned_addr" => "assigned_ip" }
                    rename => { "client_addr" => "source_ip" }
                    rename => { "server_addr" => "destination_ip" }
                    rename => { "requested_addr" => "requested_ip" }
                    rename => { "domain" => "domain_name" }
                    rename => { "host_name" => "hostname" }
                    rename => { "msg_types" => "message_types" }
                    rename => { "uids" => "uid" }
                }
            } else if [type] == "bro_dns" {
                mutate {
                    #ts
                    #uid
                    #id.orig_h
                    #id.orig_p
                    #id.resp_h
                    #id.resp_p
                    rename => { "proto" => "protocol" }
                    rename => { "trans_id" => "transaction_id" }
                    #rtt field
                    #query field
                    rename => { "qclass" => "query_class" }
                    rename => { "qclass_name" => "query_class_name" }
                    rename => { "qtype" => "query_type" }
                    rename => { "qtype_name" => "query_type_name" }
                    #rcode
                    #rcode_name
                    rename => { "AA" => "aa" }
                    rename => { "TC" => "tc" }
                    rename => { "RD" => "rd" }
                    rename => { "RA" => "ra" }
                    rename => { "Z" => "z" }
                    #answers
                    rename => { "TTLs" => "ttls" }
                    #rejected
                }
                if [tags-orig] {
                    mutate {
                        rename => { "tags-orig" => "tags" }
                        add_tag => [ "dns" ]
                    }
                }
                if [ttls] == "-" {
                    mutate {
                        remove_field => [ "ttls" ]
                    }
                }
                if [rtt] == "-" {
                    mutate {
                        remove_field => [ "rtt" ]
                    }
                }
            } else if [type] == "bro_dpd" {
                mutate {
                    #ts
                    #uid
                    #id.orig_h
                    #id.orig_p
                    #id.resp_h
                    #id.resp_p
                    rename => { "proto" => "protocol" }
                    #analyzer
                    #failure_reason
                }
            } else if [type] == "bro_files" {
                mutate {
                    #ts
                    #fuid
                    rename => { "tx_hosts" => "file_ip" }
                    rename => { "rx_hosts" => "destination_ip" }
                    rename => { "conn_uids" => "connection_uids" }
                    #source field
                    #depth field
                    rename => { "analyzers" => "analyzer" }
                    rename => { "mime_type" => "mimetype" }
                    rename => { "filename" => "file_name" }
                    #duration
                    #local_orig
                    #is_orig
                    #seen_bytes
                    #total_bytes
                    #missing_bytes
                    #overflow_bytes
                    rename => { "timedout" => "timed_out" }
                    #parent_fuid
                    #md5
                    #sha1
                    #sha256
                    #extracted
                    #extracted_cutoff
                    #extracted_size
                }
            } else if [type] == "bro_ftp" {
                mutate {
                    #ts
                    #uid
                    #id.orig_h
                    #id.orig_p
                    #id.resp_h
                    #id.resp_p
                    rename => { "user" => "username" }
                    #password
                    rename => { "command" => "ftp_command" }
                    rename => { "arg" => "ftp_argument" }
                    rename => { "mime_type" => "mimetype" }
                    #file_size
                    #reply_code
                    rename => { "reply_msg" => "reply_message" }
                    rename => { "data_channel.passive" => "data_channel_passive" }
                    rename => { "data_channel.orig_h" => "data_channel_source_ip" }
                    rename => { "data_channel.resp_h" => "data_channel_destination_ip" }
                    rename => { "data_channel.resp_p" => "data_channel_destination_port" }
                    #fuid
                }

                mutate {
                    convert => { "reply" => "string" }
                }
            } else if [type] == "bro_http" {
                mutate {
                    #ts
                    #uid
                    #id.orig_h
                    #id.orig_p
                    #id.resp_h
                    #id.resp_p
                    #trans_depth
                    #method
                    rename => { "host" => "virtual_host" }
                    #uri
                    #referrer
                    #version
                    #convert => { "version" => "string" }
                    rename => { "user_agent" => "useragent" }
                    rename => { "request_body_len" => "request_body_length" }
                    rename => { "response_body_len" => "response_body_length" }
                    #status_code
                    #status_message
                    rename => { "status_msg" => "status_message" }
                    #info_code
                    rename => { "info_msg" => "info_message" }
                    #tags
                    # Rename http tags field to http-tags
                    rename => { "tags" => "http-tags" }
                    # Rename logstash tags field to tags
                    rename => { "username" => "user" }
                    #password
                    #proxied
                    #orig_fuids
                    #orig_filenames
                    #orig_mime_types
                    #resp_fuids
                    #resp_filenames
                    #resp_mime_types
                }
                if [http-tags] {
                    mutate {
                        remove_field => [ "http-tags" ]
                    }
                }
                if [useragent] == "-" {
                    mutate {
                        remove_field => [ "useragent" ]
                    }
                }
            } else if [type] == "bro_irc" {
                mutate {
                    #ts
                    #uid
                    #id.orig_h
                    #id.orig_p
                    #id.resp_h
                    #id.resp_p
                    #nick
                    rename => { "user" => "irc_username" }
                    rename => { "command" => "irc_command" }
                    #value
                    rename => { "addl" => "additional_info" }
                    #dcc_file_name
                    #dcc_file_size
                    #dcc_mime_type
                    #fuid
                }
            } else if [type] == "bro_kerberos" {
                mutate {
                    #ts
                    #uid
                    #id.orig_h
                    #id.orig_p
                    #id.resp_h
                    #id.resp_p
                    #request_type
                    #client
                    #service
                    rename => { "success" => "kerberos_success" }
                    rename => { "error_msg" => "error_message" }
                    rename => { "from" => "valid_from" }
                    rename => { "till" => "valid_till" }
                    #cipher
                    #forwardable
                    #renewable
                    rename => { "client_cert_subject" => "client_certificate_subject" }
                    rename => { "client_cert_fuid" => "client_certificate_fuid" }
                    rename => { "server_cert_subject" => "server_certificate_subject" }
                    rename => { "server_cert_fuid" => "server_certificate_fuid" }
                }

                mutate {
                    convert => { "kerberos_success" => "string" }
                    convert => { "renewable" => "string" }
                }
            } else if [type] == "bro_notice" {
                mutate {
                    #ts
                    #uid
                    #id.orig_h
                    #id.orig_p
                    #id.resp_h
                    #id.resp_p
                    #fuid
                    rename => { "mime" => "file_mime_type" }
                    rename => { "desc" => "file_description" }
                    rename => { "proto" => "protocol" }
                    rename => { "note" => "note" }
                    rename => { "msg" => "msg" }
                    rename => { "sub" => "sub_msg" }
                    rename => { "src" => "source_ip" }
                    rename => { "dst" => "destination_ip" }
                    #p
                    #n
                    rename => { "peer_descr" => "peer_description" }
                    rename => { "actions" => "action" }
                    #suppress_for
                    #dropped
                    #destination_country_code
                    #destination_region
                    #destination_city
                    #destination_latitude
                    #destination_longitude
                }
            } else if [type] == "bro_rdp" {
                mutate {
                    #ts
                    #uid
                    #id.orig_h
                    #id.orig_p
                    #id.resp_h
                    #id.resp_p
                    #cookie
                    #result
                    #security_protocol
                    #keyboard_layout
                    #client_build
                    #client_name
                    rename => { "client_dig_product_id" => "client_digital_product_id" }
                    #desktop_width
                    #desktop_height
                    #requested_color_depth
                    rename => { "cert_type" => "certificate_type" }
                    rename => { "cert_count" => "certificate_count" }
                    rename => { "cert_permanent" => "certificate_permanent" }
                    #encryption_level
                    #encryption_method
                }
            } else if [type] == "bro_signatures" {
                mutate {
                    #ts
                    #uid
                    #id.orig_h
                    #id.orig_p
                    #id.resp_h
                    #id.resp_p
                    #note
                    rename => { "sig_id" => "signature_id" }
                    rename => { "event_msg" => "event_message" }
                    rename => { "sub_msg" => "sub_message" }
                    rename => { "sig_count" => "signature_count" }
                    #host_count
                }
            } else if [type] == "bro_smtp" {
                mutate {
                    #ts
                    #uid
                    #id.orig_h
                    #id.orig_p
                    #id.resp_h
                    #id.resp_p
                    #trans_depth
                    #helo
                    rename => { "mailfrom" => "mail_from" }
                    rename => { "rcptto" => "recipient_to" }
                    rename => { "date" => "mail_date" }
                    #from
                    #to
                    #cc
                    #reply_to
                    rename => { "msg_id" => "message_id" }
                    #in_reply_to
                    #subject
                    #x_originating_ip
                    #first_received
                    #second_received
                    #last_reply
                    #path
                    rename => { "user_agent" => "useragent" }
                    #tls
                    #fuids
                    #is_webmail
                }

                mutate {
                    convert => { "tls" => "string" }
                    convert => { "is_webmail" => "string" }
                }
                if [useragent] == "-" {
                    mutate {
                        remove_field => [ "useragent" ]
                    }
                }
            } else if [type] == "bro_snmp" {
                mutate {
                    #ts
                    #uid
                    #id.orig_h
                    #id.orig_p
                    #id.resp_h
                    #id.resp_p
                    #duration
                    #version
                    #convert => { "version" => "string" }
                    #community
                    #get_requests
                    #get_bulk_requests
                    #get_responses
                    #set_requests
                    #display_string
                    #up_since
                }
            } else if [type] == "bro_software" {
                mutate {
                    #ts
                    #uid
                    rename => { "host" => "source_ip" }
                    rename => { "host_p" => "source_port" }
                    #software_type
                    #name
                    rename => { "version.major" => "version_major" }
                    rename => { "version.minor" => "version_minor" }
                    rename => { "version.minor2" => "version_minor2" }
                    rename => { "version.minor3" => "version_minor3" }
                    rename => { "version.addl" => "version_additional_info" }
                    #unparsed_version
                }

                mutate {
                    convert => { "version_major" => "string" }
                    convert => { "version_minor" => "string" }
                }
            } else if [type] == "bro_ssh" {
                mutate {
                    #ts
                    #uid
                    #id.orig_h
                    #id.orig_p
                    #id.resp_h
                    #id.resp_p
                    #version
                    #convert => { "version" => "string" }
                    rename => { "auth_success" => "authentication_success" }
                    rename => { "auth_attempts" => "authentication_attempts" }
                    #direction
                    #client
                    #server
                    rename => { "cipher_alg" => "cipher_algorithm" }
                    rename => { "compression_alg" => "compression_algorithm" }
                    rename => { "cshka" => "client_host_key_algorithms" }
                    rename => { "host_key_alg" => "host_key_algorithm" }
                    rename => { "hasshAlgorithms" => "hassh_algorithms" }
                    rename => { "hasshServer" => "hassh_server" }
                    rename => { "hasshServerAlgorithms" => "hassh_server_algorithms" }
                    rename => { "hasshVersion" => "hassh_version" }
                    rename => { "kex_alg" => "kex_algorithm" }
                    rename => { "mac_alg" => "mac_algorithm" }
                    rename => { "sshka" => "server_host_key_algorithms" }
                    #host_key
                    #destination_country_code
                    #destination_region
                    #destination_city
                    #destination_latitude
                    #destination_longitude
                }

                mutate {
                    convert => { "authentication_success" => "string" }
                }
            } else if [type] == "bro_ssl" {
                mutate {
                    #ts
                    #uid
                    #id.orig_h
                    #id.orig_p
                    #id.resp_h
                    #id.resp_p
                    #version
                    #convert => { "version" => "string" }
                    #cipher
                    #curve
                    #server_name
                    #resumed
                    #last_alert
                    #next_protocol
                    #established
                    rename => { "cert_chain_fuids" => "certificate_chain_fuids" }
                    rename => { "client_cert_chain_fuids" => "client_certificate_chain_fuids" }
                    rename => { "subject" => "certificate_subject" }
                    rename => { "issuer" => "certificate_issuer" }
                    #client_subject
                    #client_issuer
                    #validation_status
                    #ja3
                }
                mutate {
                    gsub => [ "subject", "\\\\,", "|" ]
                }
                kv {
                    include_keys => [ "CN", "C", "O", "OU", "ST", "SN", "L", "DC", "GN", "pseudonym", "serialNumber", "title", "initials" ]
                    field_split => ","
                    source => "certificate_issuer"
                }
                mutate {
                    rename => { "CN" => "issuer_common_name"}
                    rename => { "C" => "issuer_country_code"}
                    rename => { "O" => "issuer_organization"}
                    rename => { "OU" => "issuer_organization_unit"}
                    rename => { "ST" => "issuer_state"}
                    rename => { "SN" => "issuer_surname"}
                    rename => { "L" => "issuer_locality"}
                    rename => { "DC" => "issuer_distinguished_name"}
                    rename => { "GN" => "issuer_given_name"}
                    rename => { "pseudonym" => "issuer_pseudonym"}
                    rename => { "serialNumber" => "issuer_serial_number"}
                    rename => { "title" => "issuer_title"}
                    rename => { "initials" => "issuer_initials"}
                }
                kv {
                    include_keys => [ "CN", "C", "O", "OU", "ST", "SN", "L", "GN", "pseudonym", "serialNumber", "title", "initials" ]
                    field_split => ","
                    source => "certificate_subject"
                }
                mutate {
                    rename => { "CN" => "certificate_common_name"}
                    rename => { "C" => "certificate_country_code"}
                    rename => { "O" => "certificate_organization"}
                    rename => { "OU" => "certificate_organization_unit"}
                    rename => { "ST" => "certificate_state"}
                    rename => { "SN" => "certificate_surname"}
                    rename => { "L" => "certificate_locality"}
                    rename => { "GN" => "certificate_given_name"}
                    rename => { "pseudonym" => "certificate_pseudonym"}
                    rename => { "serialNumber" => "certificate_serial_number"}
                    rename => { "title" => "certificate_title"}
                    rename => { "initials" => "certificate_initials"}
                }
                if [certificate_subject] == "-" {
                    mutate {
                        remove_field => [ "certificate_subject" ]
                    }
                }
                if [certificate_issuer] == "-" {
                    mutate {
                        remove_field => [ "certificate_issuer" ]
                    }
                }
                if [certificate_common_name] {
                    ruby {
                        code => "event.set('certificate_common_name_length', event.get('certificate_common_name').length)"
                    }
                }
                if [issuer_common_name] {
                    ruby {
                        code => "event.set('issuer_common_name_length', event.get('issuer_common_name').length)"
                    }
                }
                if [server_name] {
                    if [server_name] == "-" {
                        mutate {
                            remove_field => [ "server_name" ]
                        }
                    } else {
                        ruby {
                            code => "event.set('server_name_length', event.get('server_name').length)"
                        }
                    }
                }
                if [certificate_chain_fuids] {
                    if [certificate_chain_fuids] == "-" {
                        mutate {
                            remove_field => [ "certificate_chain_fuids" ]
                        }
                    } else {
                        ruby {
                            code => "event.set('certificate_chain_count', event.get('certificate_chain_fuids').count(',') + 1)"
                        }
                        mutate {
                            convert => [ "certificate_chain_length", "integer" ]
                        }
                    }
                }
                if [client_certificate_chain_fuids] == "-" {
                    mutate {
                        remove_field => [ "client_certificate_chain_fuids" ]
                    }
                }
                if [client_issuer] == "-" {
                    mutate {
                        remove_field => [ "client_issuer" ]
                    }
                }
                if [client_subject] == "-" {
                    mutate {
                        remove_field => [ "client_subject" ]
                    }
                }
                if [curve] == "-" {
                    mutate {
                        remove_field => [ "curve" ]
                    }
                }
                if [issuer] == "-" {
                    mutate {
                        remove_field => [ "issuer" ]
                    }
                }
                if [query] == "-" {
                    mutate {
                        remove_field => [ "query" ]
                    }
                }
                if [subject] == "-" {
                    mutate {
                        remove_field => [ "subject" ]
                    }
                }
                if [validation_status] == "-" {
                    mutate {
                        remove_field => [ "validation_status" ]
                    }
                }
                if [ja3] == "-" {
                    mutate {
                        remove_field => [ "ja3" ]
                    }
                }
            } else if [type] == "bro_syslog" {
                mutate {
                    #ts
                    #uid
                    #id.orig_h
                    #id.orig_p
                    #id.resp_h
                    #id.resp_p
                    rename => { "proto" => "protocol" }
                    #facility
                    #severity
                    #message
                }
	    } else if [type] == "bro_tunnels" {
                mutate {
                    #ts
                    #uid
                    #id.orig_h
                    #id.orig_p
                    #id.resp_h
                    #id.resp_p
                    #tunnel_type
                    #action
                }
            } else if [type] == "bro_weird" {
                mutate {
                    #ts
                    #uid
                    #id.orig_h
                    #id.orig_p
                    #id.resp_h
                    #id.resp_p
                    #name
                    rename => { "addl" => "additional_info" }
                    #notice
                    #peer
                }
                
                mutate {
                    convert => { "notice" => "string" }
                }
            } else if [type] == "bro_mysql" {
                mutate {
                    #ts
                    #uid
                    #id.orig_h
                    #id.orig_p
                    #id.resp_h
                    #id.resp_p
                    rename => { "cmd" => "mysql_command" }
                    rename => { "arg" => "mysql_argument" }
                    rename => { "success" => "mysql_success" }
                    #rows
                    #response
                }

                mutate {
                    convert => { "mysql_success" => "string" }
                }
            } else if [type] == "bro_socks" {
                mutate {
                    #ts
                    #uid
                    #id.orig_h
                    #id.orig_p
                    #id.resp_h
                    #id.resp_p
                    #version
                    #convert => { "version" => "string" }
                    #user
                    #password
                    rename => { "status" => "server_status" }
                    #request_host
                    #request_name
                    rename => { "request_p" => "request_port" }
                    #bound_host
                    #bound_name
                    rename => { "bound_p" => "bound_port" }
                }
            } else if [type] == "bro_x509" {
                mutate {
                    #ts
                    #id
                    rename => { "certificate.version" => "certificate_version" }
                    rename => { "certificate.serial" => "certificate_serial" }
                    rename => { "certificate.subject" => "certificate_subject" }
                    rename => { "certificate.issuer" => "certificate_issuer" }
                    rename => { "certificate.not_valid_before" => "certificate_not_valid_before" }
                    rename => { "certificate.not_valid_after" => "certificate_not_valid_after" }
                    rename => { "certificate.key_alg" => "certificate_key_algorithm" }
                    rename => { "certificate.sig_alg" => "certificate_signing_algorithm" }
                    rename => { "certificate.key_type" => "certificate_key_type" }
                    rename => { "certificate.key_length" => "certificate_key_length" }
                    rename => { "certificate.exponent" => "certificate_exponent" }
                    rename => { "certificate.curve" => "certificate_curve" }
                    rename => { "san.dns" => "san_dns" }
                    rename => { "san.uri" => "san_uri" }
                    rename => { "san.email" => "san_email" }
                    rename => { "san.ip" => "san_ip" }
                    rename => { "basic_constraints.ca" => "basic_constraints_ca" }
                    rename => { "basic_constraints.path_length" => "basic_constraints_path_length" }
                }
                mutate {
                    gsub => [ "certificate_issuer", "\\\\,", "|" ]
                    gsub => [ "certificate_subject", "\\\\,", "|" ]
                }
                kv {
                    include_keys => [ "CN", "C", "O", "OU", "ST", "SN", "L", "DC", "GN", "pseudonym", "serialNumber", "title", "initials" ]
                    field_split => ","
                    source => "certificate_issuer"
                }
                mutate {
                    rename => { "CN" => "issuer_common_name"}
                    rename => { "C" => "issuer_country_code"}
                    rename => { "O" => "issuer_organization"}
                    rename => { "OU" => "issuer_organization_unit"}
                    rename => { "ST" => "issuer_state"}
                    rename => { "SN" => "issuer_surname"}
                    rename => { "L" => "issuer_locality"}
                    rename => { "DC" => "issuer_distinguished_name"}
                    rename => { "GN" => "issuer_given_name"}
                    rename => { "pseudonym" => "issuer_pseudonym"}
                    rename => { "serialNumber" => "issuer_serial_number"}
                    rename => { "title" => "issuer_title"}
                    rename => { "initials" => "issuer_initials"}
                }
                kv {
                    include_keys => [ "CN", "C", "O", "OU", "ST", "SN", "L", "GN", "pseudonym", "serialNumber", "title", "initials" ]
                    field_split => ","
                    source => "certificate_subject"
                }
                mutate {
                    rename => { "CN" => "certificate_common_name"}
                    rename => { "C" => "certificate_country_code"}
                    rename => { "O" => "certificate_organization"}
                    rename => { "OU" => "certificate_organization_unit"}
                    rename => { "ST" => "certificate_state"}
                    rename => { "SN" => "certificate_surname"}
                    rename => { "L" => "certificate_locality"}
                    rename => { "GN" => "certificate_given_name"}
                    rename => { "pseudonym" => "certificate_pseudonym"}
                    rename => { "serialNumber" => "certificate_serial_number"}
                    rename => { "title" => "certificate_title"}
                    rename => { "initials" => "certificate_initials"}
                    convert => [ "certificate_key_length", "integer" ]
                    convert => [ "certificate_not_valid_after", "integer" ]
                    convert => [ "certificate_not_valid_before", "integer" ]
                }
                if [query] == "-" {
                    mutate {
                        remove_field => [ "query" ]
                    }
                }
                if [san_dns] == "-" {
                    mutate {
                        remove_field => [ "san_dns" ]
                    }
                }
                if [san_email] == "-" {
                    mutate {
                        remove_field => [ "san_email" ]
                    }
                }
                if [san_uri] == "-" {
                    mutate {
                        remove_field => [ "san_uri" ]
                    }
                }
                if [san_ip] == "-" {
                    mutate {
                        remove_field => [ "san_ip" ]
                    }
                }
                if [certificate_common_name] {
                    ruby {
                        code => "event.set('certificate_common_name_length', event.get('certificate_common_name').length)"
                    }
                }
                if [issuer_common_name] {
                    ruby {
                        code => "event.set('issuer_common_name_length', event.get('issuer_common_name').length)"
                    }
                }
                if [certificate_not_valid_after] == "-" {
                    mutate {
                        remove_field => [ "certificate_not_valid_after" ]
                    }
                }
                if [certificate_not_valid_before] == "-" {
                    mutate {
                        remove_field => [ "certificate_not_valid_before" ]
                    }
                }
                if [certificate_not_valid_after] and [certificate_not_valid_before] {
                    ruby {
                        code => "event.set('certificate_number_days_valid', ((event.get('certificate_not_valid_after') - event.get('certificate_not_valid_before')) / 86400).ceil)"
                    }
                    date {
                        match => [ "certificate_not_valid_after", "UNIX" ]
                        target => "certificate_not_valid_after"
                    }
                    date {
                        match => [ "certificate_not_valid_before", "UNIX" ]
                        target => "certificate_not_valid_before"
                    }
                }
            } else if [type] == "bro_intel" {
                mutate {
                    #ts
                    #uid
                    #id.orig_h
                    #id.orig_p
                    #id.resp_h
                    #id.resp_p
                    rename => { "seen.indicator" => "indicator" }
                    rename => { "seen.indicator_type" => "indicator_type" }
                    rename => { "seen.where" => "seen_where" }
                    rename => { "seen.node" => "seen_node" }
                    #matched
                    #sources
                    #fuid
                    rename => { "file_mime_type" => "mimetype" }
                    rename => { "file_desc" => "file_description" }
                }
            } else if [type] == "bro_modbus" {
                mutate {
                    #ts
                    #uid
                    #id.orig_h
                    #id.orig_p
                    #id.resp_h
                    #id.resp_p
                    rename => { "func" => "function" }
                    #exception
                }
            } else if [type] == "bro_sip" {
                mutate {
                    #ts
                    #uid
                    #id.orig_h
                    #id.orig_p
                    #id.resp_h
                    #id.resp_p
                    #trans_depth
                    #method
                    #uri
                    #date
                    #request_from
                    #request_to
                    #response_from
                    #response_to
                    #reply_to
                    #call_id
                    #seq
                    #subject
                    #request_path
                    #response_path
                    #user_agent
                    #status_code
                    #status_msg
                    #warning
                    #request_body_len
                    #response_body_len
                    #content_type
                }
            } else if [type] == "bro_radius" {
                mutate {
                    #ts
                    #uid
                    #id.orig_h
                    #id.orig_p
                    #id.resp_h
                    #id.resp_p
                    #username
                    #mac
                    #framed_addr
                    #remote_ip
                    #connect_info
                    rename => { "reply_msg" => "reply_message" }
                    #result
                    #ttl
                    #logged
                }
                if [remote_ip] == "-" {
                    mutate {
                        remove_field => [ "remote_ip" ]
                    }
                }
                # Remove the ttl and framed_addr fields
                if [ttl] {
                    mutate {
                        remove_field => [ "ttl" ]
                    }
                }
                if [framed_addr] {
                    mutate {
                        remove_field => [ "framed_addr" ]
                    }
                }
            } else if [type] == "bro_pe" {
                mutate {
                    #ts
                    #fuid
                    #machine
                    #compile_ts
                    #os
                    #subsystem
                    #is_exe
                    #is_64bit
                    #uses_aslr
                    #uses_dep
                    #uses_code_integrity
                    #uses_seh
                    #has_import_table
                    #has_export_table
                    #has_cert_table
                    #has_debug_data
                    #section_names
                }
            } else if [type] == "bro_rfb" {
                mutate {
                    #ts
                    #uid
                    #id.orig_h
                    #id.orig_p
                    #id.resp_h
                    #id.resp_p
                    #client_major_version
                    #client_minor_version
                    #server_major_version
                    #server_minor_version
                    #authentication_method
                    #auth
                    #share_flag
                    #desktop_name
                    #width
                    #height
                }

                mutate {
                    convert => { "auth" => "string" }
                    convert => { "share_flag" => "string" }
                }
            } else if [type] == "bro_dnp3" {
                mutate {
                    #ts
                    #uid
                    #id.orig_h
                    #id.orig_p
                    #id.resp_h
                    #id.resp_p
                    #fc_request
                    #fc_reply
                    #iin
                }
            } else if [type] == "bro_smb_files" {
                mutate {
                    #ts
                    #uid
                    #id.orig_h
                    #id.orig_p
                    #id.resp_h
                    #id.resp_p
                    #fuid
                    #action
                    #path
                    #name
                    #size
                    #prev_name
                    rename => { "times.modified" => "times_modified" }
                    rename => { "times.accessed" => "times_accessed" }
                    rename => { "times.created" => "times_created" }
                    rename => { "times.changed" => "times_changed" }
                }
            } else if [type] == "bro_smb_mapping" {
                mutate {
                    #ts
                    #uid
                    #id.orig_h
                    #id.orig_p
                    #id.resp_h
                    #id.resp_p
                    #path
                    #service
                    #native_file_system
                    #share_type
                }
            } else if [type] == "bro_ntlm" {
                mutate {
                    #ts
                    #uid
                    #id.orig_h
                    #id.orig_p
                    #id.resp_h
                    #id.resp_p
                    #hostname
                    rename => { "domainname" => "domain_name" }
                    rename => { "success" => "ntlm_success" }
                    #status
                }
            } else if [type] == "bro_dce_rpc" {
                mutate {
                    #ts
                    #uid
                    #id.orig_h
                    #id.orig_p
                    #id.resp_h
                    #id.resp_p
                    #rtt
                    #named_pipe
                    #endpoint
                    #operation
                }
                if [rtt] == "-" {
                    mutate {
                        remove_field => [ "rtt" ]
                    }
                }
            }
            if [tags-orig] {
                mutate {
                    rename => { "tags-orig" => "tags" }
                }
            }
        }
    }
}
